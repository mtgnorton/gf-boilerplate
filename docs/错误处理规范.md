## 目标
- 统一错误处理的方式,规范错误日志和响应
- 快速定位问题,提高发现问题和解决问题的效率
- 后续考虑接入sentry,提高错误监控能力

## 概述
- gf框架所有底层组件对返回的错误都带有堆栈信息,gerror 文档: https://goframe.org/docs/core/gerror 

- 错误主要分为 **panic错误,非预期错误(如数据库查询错误等),预期错误(如输入错误)**

- 错误展示的详细程度由是否是debug模式决定,debug由配置文件决定,也可以通过请求头`x-debug`设置,后续考虑增加其他动态设置方式
- 错误日志包含堆栈信息,请求和参数相关信息,后续会增加已登录的用户信息

	| 错误类型 | 开启debug | 关闭debug |
	| -------- | ------------ | ------------ |
	| panic错误 | 和是否开启debug无关,展示详细堆栈,日志Error级别,发送飞书告警信息  |
	| 非预期错误 | 和是否开启debug无关, 展示详细堆栈,日志Error级别  |
	| 预期错误 |   展示堆栈,日志Info级别 | 不展示堆栈,日志Info级别 |
	| 响应是否返回错误 | 在error字段显示堆栈 | 否 |

## 上下文信息和返回用户的错误提示
统一使用封装的`errctx.Wrap(err error, message string, details ...interface{})`和`errctx.New(message string, details ...interface{})`方法

- 非预期错误使用
- message参数可为空,中间件会根据国际化返回,比如操作失败,如果设置了message,则优先使用设置的message
```
return nil, errctx.Wrap(err, "", map[string]interface{}{
		"id": req.Id,
	})
```
- 预期错误
```
return nil, errctx.New(g.I18n().T(ctx, "cg.role.not_found"), map[string]interface{}{
		"id": req.Id,
	})
```


## 不同错误日志和响应对比
- panic错误
	- 日志
	![](images/错误处理规范/20250422182948.png)
	- 响应
	![](images/错误处理规范/20250423104240.png)
- 非预期错误
	- 非预期错误不需要在Wrap中添加错误信息,直接使用`gerror.Wrap(err,"")`,因为堆栈信息已经足够
	- 日志
	![](images/错误处理规范/20250423140619.png)
	- 响应
	![](images/错误处理规范/20250423140648.png)
- 预期错误
	- 校验错误(不满足校验规则触发),开启debug
	![](images/错误处理规范/20250423102359.png)
	- 代码内部主动返回的错误,开启debug
	 - 日志
	![](images/错误处理规范/20250423141434.png)
	 - 响应
	![](images/错误处理规范/20250423141453.png)	 
	- 关闭debug
	![](images/错误处理规范/20250423103315.png)


